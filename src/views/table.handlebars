<style>
  .chartdiv {
    width: 100%;
    height: 500px;
  }
</style>

<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>

<div class="container-fluid">

  <ul class="nav nav-tabs border-bottom-0">
    <li class="nav-item">
      <a class="nav-link active nav-link-edit" aria-current="page" href="#" onclick="enable(0)" id="tab0" >WP2</a>
    </li>
    <li class="nav-item">
      <a class="nav-link nav-link-edit" href="#" onclick="enable(1)" id="tab1">WP3</a>
    </li>
    <li class="nav-item">
      <a class="nav-link nav-link-edit" href="#" onclick="enable(2)" id="tab2">WP4</a>
    </li>
    <li class="nav-item">
      <a class="nav-link nav-link-edit" href="#" onclick="enable(3)" id="tab3">WP5</a>
    </li>
    <li class="nav-item">
      <a class="nav-link nav-link-edit" href="#" onclick="enable(4)" id="tab4">WP6</a>
    </li>
    <li class="nav-item">
      <a class="nav-link nav-link-edit" href="#" onclick="enable(5)" id="tab5">WP7</a>
    </li>
  </ul>

  <div class="row row-cols-2">
    <div class="col">
       <table class="table" id="table0"></table>
    </div>
    <div class="col">
        <div id="chartdiv0" class="chartdiv"></div> 
    </div>
  </div>
  <div class="row row-cols-2">
    <div class="col">
       <table class="table" id="table1" style="display: none;"></table>
    </div>
    <div class="col">
      <div id="chartdiv1" class="chartdiv" style="display: none;"></div> 
    </div>
  </div>
  <div class="row row-cols-2">
    <div class="col">
       <table class="table" id="table2" style="display: none;"></table>
    </div>
    <div class="col">
      <div id="chartdiv2" class="chartdiv" style="display: none;"></div> 
    </div>
  </div>
  <div class="row row-cols-2">
    <div class="col">
       <table class="table" id="table3" style="display: none;"></table>
    </div>
    <div class="col">
      <div id="chartdiv3" class="chartdiv" style="display: none;"></div> 
    </div>
  </div>
  <div class="row row-cols-2">
    <div class="col">
       <table class="table" id="table4" style="display: none;"></table>
    </div>
    <div class="col">
      <div id="chartdiv4" class="chartdiv" style="display: none;"></div> 
    </div>
  </div>
  <div class="row row-cols-2">
    <div class="col">
       <table class="table" id="table5" style="display: none;"></table>
    </div>
    <div class="col">
      <div id="chartdiv5" class="chartdiv" style="display: none;"></div> 
    </div>
  </div>
</div>

<script>

loadDatosTablas()


var numTablas = 0;


function loadDatosTablas(){
    fetch('/datos-table', {method: 'GET'})
    .then(res =>  res.json())
    .then(data =>{
        data.sheets.forEach((sheet, index)=> {
          let id = "table"+index
          montarTabla(sheet, id)
          //console.log("Soy la sheet numero " + index + " y esto es lo que voy a enviar ")
          //console.log(sheet)
          loadJsonDatos(sheet,index)
          numTablas+=1
        })
    })
    .catch(e => {
      console.log(e);
    });
}

function montarTabla(json, idTabla){
 let html = ''
 json.sheet.forEach( (element, index) => {
 if(index == 0){
    html+= `<thead><tr>`
    element.filanueva.forEach((clave) => {
    html+=`<th>${clave.clave}</th>`
    })
      html+= `</thead></tr>`
    }else{
      html+= `<tbody><tr>`
      element.filanueva.forEach((clave) => {
        html+=`<td>${clave.clave}</td>`
      })
        html+= `</tbody></tr>`
    }
});

var tabla = document.getElementById(idTabla)
tabla.innerHTML = html

}

function enable(id){
  disableRest()
  var idTabla = "table"+id
  var idTab = "tab"+id
  var idGraph = "chartdiv"+id
  var tabla = document.getElementById(idTabla).style.display="block"
  var tab = document.getElementById(idTab).classList.add("active")
  var graph = document.getElementById(idGraph).style.display="block"

}

function disableRest(){
  for(let i=0; i<numTablas; i++){
    var idTabla = "table"+i
    var idTab = "tab"+i
    var idGraph = "chartdiv"+i
    var tabla = document.getElementById(idTabla).style.display="none"
    var tab = document.getElementById(idTab).classList.remove("active")
    var graph = document.getElementById(idGraph).style.display="none"
  } 
  
}

function loadJsonDatos(jsonSheet,id){
  let data2=[]

  jsonSheet.sheet.forEach((entrada, index)=>{
    if(index == 0){
      
    }else{
        
      let jsonAux = {
        "CODE":"",
        "TRIM1":0,
        "TRIM2":0,
        "TRIM3":0,
      }

      jsonAux.CODE = entrada.filanueva[2].clave

      if(entrada.filanueva[3].clave == "-"){
        jsonAux.TRIM1 = 0
      }else{
        jsonAux.TRIM1 = entrada.filanueva[3].clave
      }
      
      if(entrada.filanueva[4].clave == "-"){
        jsonAux.TRIM2 = 0
      }else{
        jsonAux.TRIM2 = entrada.filanueva[4].clave
      }

      if(entrada.filanueva[5].clave == "-"){
        jsonAux.TRIM3 = 0
      }else{
        jsonAux.TRIM3 = entrada.filanueva[5].clave
      }

      data2.push(jsonAux) 
      
    }

  })
    loadGraficos(data2, id)
}


function loadGraficos(data4, id){

/*var data3 = [{
        "CODE":"WP2",
        "TRIM1":100,
        "TRIM2":500,
        "TRIM3":50,
      },{
        "CODE":"WP3",
        "TRIM1":500,
        "TRIM2":1000,
        "TRIM3":10,
      },{
        "CODE":"WP4",
        "TRIM1":500,
        "TRIM2":50,
        "TRIM3":1000,
}]*/

console.log(data4)
am5.ready(function() {

  let chartdiv = "chartdiv"+id
  var root = am5.Root.new(chartdiv);

  root.setThemes([
    am5themes_Animated.new(root)
  ]);

  var chart = root.container.children.push(am5xy.XYChart.new(root, {
    panX: false,
    panY: false,
    wheelX: "panX",
    wheelY: "zoomX",
    layout: root.verticalLayout
  }));

  chart.set("scrollbarX", am5.Scrollbar.new(root, {
    orientation: "horizontal"
  })); 

  var xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, {
    categoryField: "CODE",
    renderer: am5xy.AxisRendererX.new(root, {}),
    tooltip: am5.Tooltip.new(root, {})
  }));

  xAxis.data.setAll(data4);

  var yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
    min: 0,
    renderer: am5xy.AxisRendererY.new(root, {})
  }));

  var legend = chart.children.push(am5.Legend.new(root, {
    centerX: am5.p50,
    x: am5.p50
  }));

  function makeSeries(name, fieldName) {
    var series = chart.series.push(am5xy.ColumnSeries.new(root, {
      name: name,
      stacked: true,
      xAxis: xAxis,
      yAxis: yAxis,
      valueYField: fieldName,
      categoryXField: "CODE"
    }));

    series.columns.template.setAll({
      tooltipText: "{name}, {categoryX}: {valueY}",
      tooltipY: am5.percent(10)
    });
    series.data.setAll(data4);

    series.appear();

    series.bullets.push(function () {
      return am5.Bullet.new(root, {
        sprite: am5.Label.new(root, {
          text: "{valueY}",
          fill: root.interfaceColors.get("alternativeText"),
          centerY: am5.p50,
          centerX: am5.p50,
          populateText: true
        })
      });
    });

    legend.data.push(series);
  }

  makeSeries("1ºTRIM", "TRIM1");
  makeSeries("2ºTRIM", "TRIM2");
  makeSeries("3ºTRIM", "TRIM3");

  chart.appear(1000, 100);

});
}

</script>
